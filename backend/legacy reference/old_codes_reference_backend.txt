OLD database.py

"""
FinEdge MongoDB Database Connection Module

Handles connection to MongoDB Atlas and provides database access
for user profile management, onboarding data, and financial records.

Author: FinEdge Team
Version: 1.0.0
"""

import os
import logging
from typing import Optional
from pymongo import MongoClient
from pymongo.database import Database
from pymongo.errors import ConnectionFailure, ServerSelectionTimeoutError
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# MongoDB Configuration
MONGODB_URI = os.environ.get("MONGODB_URI")
MONGODB_DB_NAME = os.environ.get("MONGODB_DB_NAME", "finedge_db")

# Global database connection
_db_client: Optional[MongoClient] = None
_database: Optional[Database] = None


def get_database() -> Database:
    """
    Get MongoDB database instance with connection pooling.
    
    Creates a new connection if none exists, otherwise returns existing connection.
    Uses connection pooling for efficient resource management.
    
    Returns:
        Database: MongoDB database instance
        
    Raises:
        ValueError: If MONGODB_URI is not set in environment
        ConnectionFailure: If unable to connect to MongoDB
    """
    global _db_client, _database
    
    # Return existing connection if available
    if _database is not None:
        return _database
    
    # Validate MongoDB URI
    if not MONGODB_URI:
        raise ValueError(
            "MONGODB_URI environment variable is not set. "
            "Please check your .env file and ensure MongoDB Atlas connection string is configured."
        )
    
    try:
        logger.info("Connecting to MongoDB Atlas...")
        
        # Create MongoDB client with connection pooling
        # serverSelectionTimeoutMS: 5 seconds to wait for server selection
        # connectTimeoutMS: 10 seconds to establish connection
        # maxPoolSize: Maximum 50 connections in pool
        _db_client = MongoClient(
            MONGODB_URI,
            serverSelectionTimeoutMS=5000,
            connectTimeoutMS=10000,
            maxPoolSize=50
        )
        
        # Verify connection by pinging the database
        _db_client.admin.command('ping')
        
        # Get database instance
        _database = _db_client[MONGODB_DB_NAME]
        
        logger.info(f"‚úÖ Successfully connected to MongoDB database: {MONGODB_DB_NAME}")
        return _database
        
    except ServerSelectionTimeoutError as e:
        logger.error(f"‚ùå MongoDB connection timeout. Please check:")
        logger.error("   1. MongoDB Atlas cluster is running")
        logger.error("   2. Network access is configured (IP whitelist)")
        logger.error("   3. Connection string is correct")
        raise ConnectionFailure(f"Failed to connect to MongoDB: {e}")
        
    except ConnectionFailure as e:
        logger.error(f"‚ùå MongoDB connection failed: {e}")
        raise
        
    except Exception as e:
        logger.error(f"‚ùå Unexpected error connecting to MongoDB: {e}")
        raise


def close_database_connection():
    """
    Close the MongoDB connection.
    
    Should be called when application shuts down to properly
    release database resources and connections.
    """
    global _db_client, _database
    
    if _db_client is not None:
        _db_client.close()
        _db_client = None
        _database = None
        logger.info("MongoDB connection closed")


def test_connection() -> bool:
    """
    Test MongoDB connection.
    
    Useful for health checks and debugging.
    
    Returns:
        bool: True if connection successful, False otherwise
    """
    try:
        db = get_database()
        # Try to list collections to verify read access
        collections = db.list_collection_names()
        logger.info(f"‚úÖ MongoDB connection test successful. Found {len(collections)} collections.")
        return True
    except Exception as e:
        logger.error(f"‚ùå MongoDB connection test failed: {e}")
        return False


# Collection names (constants for consistency)
class Collections:
    """MongoDB collection names used in FinEdge application"""
    USER_PROFILES = "user_profiles"      # Main user profile and onboarding data
    INCOME = "income_entries"            # User income records
    EXPENSES = "expense_entries"         # User expense records
    ASSETS = "asset_entries"             # User asset records
    LIABILITIES = "liability_entries"    # User liability records
    GOALS = "financial_goals"            # User financial goals
    SESSIONS = "user_sessions"           # User session data (optional)


# Initialize database connection on module import (optional - can be lazy loaded)
try:
    get_database()
except Exception as e:
    logger.warning(f"‚ö†Ô∏è Could not initialize database on startup: {e}")
    logger.warning("Database will be initialized on first request")
# End of backend/database.py

































































# @app.route('/chat-history', methods=['GET'])
# def get_chat_history_endpoint():
#     """Get chat history for a specific session"""
#     try:
#         session_id = request.args.get('session_id', 'default')
        
#         if get_chat_history:
#             history = get_chat_history(session_id)
#             return jsonify({
#                 'session_id': session_id,
#                 'history': history,
#                 'message_count': len(history)
#             })
#         else:
#             return jsonify({'error': 'Session management not available'}), 503
            
#     except Exception as e:
#         logger.error(f"Error getting chat history: {e}")
#         return jsonify({'error': 'Internal server error'}), 500

# =================== BOTS ===================
# Add your bot endpoints here



















# @app.route('/active-sessions', methods=['GET'])
# def get_active_sessions_endpoint():
#     """Get list of all active chat sessions"""
#     try:
#         if get_active_sessions:
#             sessions = get_active_sessions()
#             return jsonify({
#                 'active_sessions': sessions,
#                 'count': len(sessions)
#             })
#         else:
#             return jsonify({'error': 'Session management not available'}), 503
            
#     except Exception as e:
#         logger.error(f"Error getting active sessions: {e}")
#         return jsonify({'error': 'Internal server error'}), 500





















# @app.route('/clear-chat-session', methods=['POST'])
# def clear_chat_session_endpoint():
#     """Clear a specific chat session"""
#     try:
#         session_id = request.form.get('session_id', 'default')
        
#         if clear_chat_session:
#             success = clear_chat_session(session_id)
#             return jsonify({
#                 'success': success,
#                 'message': f'Session {session_id} cleared successfully' if success else f'Session {session_id} not found'
#             })
#         else:
#             return jsonify({'error': 'Session management not available'}), 503
            
#     except Exception as e:
#         logger.error(f"Error clearing chat session: {e}")
#         return jsonify({'error': 'Internal server error'}), 500

























































# @app.route('/agent', methods=['POST'])
# def agent():
#     inp = request.form.get('input')
#     session_id = request.form.get('session_id', 'default')  # Get session ID from request
    
#     if not inp:
#         return jsonify({'error': 'No input provided'}), 400
    
#     # Basic input validation
#     if len(inp) > 1000:  # Prevent extremely long inputs
#         return jsonify({'error': 'Input too long'}), 400
    
#     try:
#         print(f"Processing input: {inp}")
        
#         # Add timeout to prevent hanging - use full path to ensure correct environment
#         import os
#         import sys
#         python_executable = sys.executable  # Use the same Python that's running Flask
#         agent_path = os.path.join(os.path.dirname(__file__), 'agent.py')
        
#         process = subprocess.Popen(
#             [python_executable, agent_path, inp], 
#             stdout=subprocess.PIPE, 
#             stderr=subprocess.PIPE,
#             universal_newlines=True,
#             cwd=os.path.dirname(__file__)  # Set working directory to backend folder
#         )
        
#         output = []
#         # Stream output in real-time
#         if process.stdout is not None:
#             while True:
#                 line = process.stdout.readline()
#                 if not line and process.poll() is not None:
#                     break
#                 if line:
#                     print(line.strip())  # Print to terminal in real-time
#                     output.append(line)
#         else:
#             logger.error("process.stdout is None")
        
#         output_str = ''.join(output)
#         return_code = process.wait()
        
#         # Check if process failed
#         if return_code != 0:
#             if process.stderr is not None:
#                 stderr = process.stderr.read()
#             else:
#                 stderr = ""
#                 logger.error("process.stderr is None")
#             logger.error(f"Agent script failed with return code {return_code}")
#             logger.error(f"STDERR: {stderr}")
#             logger.error(f"STDOUT: {output_str}")
#             return jsonify({
#                 'error': 'Agent processing failed', 
#                 'details': stderr[:500],  # Include error details for debugging
#                 'return_code': return_code
#             }), 500
        
#         # Debug: Log the full output to see what we received
#         logger.info(f"Agent output: {output_str[:500]}...")  # Log first 500 chars
        
#         # Use regex to extract the response between <Response> tags
#         final_answer = re.search(r'<Response>(.*?)</Response>', output_str, re.DOTALL)
#         if final_answer:
#             final_answer = final_answer.group(1).strip()
#         else:
#             logger.warning(f"No <Response> tags found in output. Full output: {output_str}")
#             # Try to extract the agent's final answer differently
#             if "Final Answer:" in output_str:
#                 # Extract everything after "Final Answer:"
#                 final_answer = output_str.split("Final Answer:")[-1].strip()
#             else:
#                 # Fallback to backup AI if available
#                 if jgaad_chat_with_gemini:
#                     try:
#                         final_answer = jgaad_chat_with_gemini(inp, output_str, session_id)
#                     except Exception as e:
#                         logger.error(f"Backup AI failed: {e}")
#                         final_answer = "Error processing request"
#                 else:
#                     final_answer = f"Agent ran but no proper response found. Output: {output_str[-200:]}"
        
#         return jsonify({'output': final_answer, 'thought': output_str})
        
#     except subprocess.TimeoutExpired:
#         process.kill()
#         return jsonify({'error': 'Request timed out'}), 500
#     except Exception as e:
#         logger.error(f"Error in agent endpoint: {e}")
#         return jsonify({'error': 'Internal server error'}), 500

# @app.route('/ai-financial-path', methods=['POST'])
# def ai_financial_path():
#     # Fix the original bug - check if 'input' exists in form data
#     if 'input' not in request.form:
#         return jsonify({'error': 'No input provided'}), 400
        
#     input_text = request.form.get('input', '').strip()
#     if not input_text:
#         return jsonify({'error': 'Input cannot be empty'}), 400
        
#     risk = request.form.get('risk', 'conservative')
    
#     # Validate risk level
#     allowed_risks = ['conservative', 'moderate', 'aggressive']
#     if risk not in allowed_risks:
#         return jsonify({'error': f'Invalid risk level. Allowed: {allowed_risks}'}), 400
    
#     print(f"Processing financial path for: {input_text}, risk: {risk}")
    
#     if not gemini_fin_path:
#         return jsonify({'error': 'Financial AI service not available'}), 503
    
#     try:
#         response = gemini_fin_path.get_gemini_response(input_text, risk)
#         return jsonify(response)
#     except Exception as e:
#         logger.error(f"Financial path error: {e}")
#         return jsonify({'error': 'Something went wrong'}), 500















# try:
#     from jgaad_ai_agent_backup import jgaad_chat_with_gemini, clear_chat_session, get_active_sessions, get_chat_history
#     import gemini_fin_path
# except ImportError:
#     logging.warning("Could not import AI modules")
#     jgaad_chat_with_gemini = None
#     clear_chat_session = None
#     get_active_sessions = None
#     get_chat_history = None
#     gemini_fin_path = None























# NEW - ADDED: Test MongoDB connection on startup
# @app.before_first_request
# def initialize_database():
#     """Initialize and test database connection"""
#     logger.info("Initializing MongoDB connection...")
#     if test_connection():
#         logger.info("‚úÖ MongoDB Atlas connected successfully")
#     else:
#         logger.error("‚ùå MongoDB connection failed - check configuration")

# # NEW - ADDED: Close database connection on shutdown
# @app.teardown_appcontext
# def shutdown_database(exception=None):
#     """Close database connection when app shuts down"""
#     close_database_connection()


























































# def init_app():
#     """Initialize application and database connection"""
#     with app.app_context():
#         logger.info("Initializing MongoDB connection...")
#         try:
#             if test_connection():
#                 logger.info("‚úÖ MongoDB Atlas connected successfully")
#             else:
#                 logger.warning("‚ö†Ô∏è MongoDB connection test failed - will retry on first request")
#         except Exception as e:
#             logger.warning(f"‚ö†Ô∏è MongoDB initialization warning: {e}")
#             logger.warning("Database will connect on first request")





































































    //   case 2:
    //     return (
    //       <OnboardingLayout
    //         title="Add Your Income Sources"
    //         description="Let's start by understanding your income. Add all sources of income you receive."
    //       >
    //         {/* IncomeStep will be added in PART 2C */}
    //         <div className="text-center py-12 text-gray-500">
    //           Income step coming in PART 2C...
    //         </div>
    //       </OnboardingLayout>
    //     );
      
    //   case 3:
    //     return (
    //       <OnboardingLayout
    //         title="Track Your Expenses"
    //         description="Add your regular expenses to get a complete financial picture."
    //       >
    //         {/* ExpensesStep will be added in PART 2C */}
    //         <div className="text-center py-12 text-gray-500">
    //           Expenses step coming in PART 2C...
    //         </div>
    //       </OnboardingLayout>
    //     );
      
    //   case 4:
    //     return (
    //       <OnboardingLayout
    //         title="List Your Assets"
    //         description="Add all your assets including properties, investments, and savings."
    //       >
    //         {/* AssetsStep will be added in PART 2C */}
    //         <div className="text-center py-12 text-gray-500">
    //           Assets step coming in PART 2C...
    //         </div>
    //       </OnboardingLayout>
    //     );
      
    //   case 5:
    //     return (
    //       <OnboardingLayout
    //         title="Add Your Liabilities"
    //         description="Include any loans, debts, or financial obligations you have."
    //       >
    //         {/* LiabilitiesStep will be added in PART 2C */}
    //         <div className="text-center py-12 text-gray-500">
    //           Liabilities step coming in PART 2C...
    //         </div>
    //       </OnboardingLayout>
    //     );



































          case 6:
        return (
          <OnboardingLayout
            title="Review & Submit"
            description="Review your financial information before submitting."
            showNext={true}
            nextLabel="Complete Onboarding"
          >
            {/* ReviewStep will be added in PART 2D */}
            <div className="text-center py-12 text-gray-500">
              Review step coming in PART 2D...
            </div>
          </OnboardingLayout>
        );



















































        import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { ClerkProvider } from '@clerk/clerk-react';
import { ThemeProvider } from './context/ThemeContext';
import { TourProvider } from './context/TourContext';
import ProtectedRoute from './components/ProtectedRoute';
import Navbar from './components/Navbar';
import Home from './pages/Home';
import Portfolio from './pages/Portfolio';
import MyData from './pages/MyData/index';
import Recommendations from './pages/Recommendations';
import Learn from './pages/Learn';
import Profile from './pages/Profile';
import AuthComponent from './components/AuthComponent';
import DashboardLayout from './components/DashboardLayout';
import FinancialPathFlow from './components/FinancialPathFlow';
import Chatbot from './pages/Chatbot';
import MoneyPulse from './components/MoneyPulse';
import MoneyCalc from './components/MoneyCalc';
import StockAnalyzer from './pages/StockAnalyzer';
import SSOCallback from './components/SSOCallback';

const clerkPubKey = import.meta.env.VITE_CLERK_PUBLISHABLE_KEY;

function App() {
  return (
    <ClerkProvider publishableKey={clerkPubKey}>
      <ThemeProvider>
        <TourProvider>
          <Router>
            <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
              <Routes>
                <Route path="/" element={<><Navbar /><Home /></>} />
                <Route path="/sign-in" element={<AuthComponent />} />
                <Route path="/sign-up" element={<AuthComponent />} />
                <Route path="/sign-up/sso-callback" element={<SSOCallback />} />
                <Route path="/portfolio" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <Portfolio />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/my-data" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <MyData />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/recommendations" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <Recommendations />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/learn" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <Learn />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/profile" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <Profile />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/financial-path" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <FinancialPathFlow />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/chatbot" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <Chatbot />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/money-pulse" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <MoneyPulse />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/money-calc" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <MoneyCalc />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
                <Route path="/portfolio/stock-analyzer" element={
                  <ProtectedRoute>
                    <DashboardLayout>
                      <StockAnalyzer />
                    </DashboardLayout>
                  </ProtectedRoute>
                } />
              </Routes>
            </div>
          </Router>
        </TourProvider>
      </ThemeProvider>
    </ClerkProvider>
  );
}

export default App;









































import { useUser } from '@clerk/clerk-react';
import { Navigate } from 'react-router-dom';
import FullPageLoader from './FullPageLoader';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

const ProtectedRoute = ({ children }: ProtectedRouteProps) => {
  const { isLoaded, isSignedIn } = useUser();

  if (!isLoaded) {
    return <FullPageLoader />;
  }

  if (!isSignedIn) {
    return <Navigate to="/sign-in" />;
  }

  return <>{children}</>;
};

export default ProtectedRoute; 





































































# ==========================================
# GOALS ENDPOINTS
# ==========================================

@app.route('/api/user-profile/goals', methods=['GET'])
def get_goals():
    """Get all goals for a user"""
    try:
        clerk_user_id = request.args.get('clerkUserId')
        if not clerk_user_id:
            return jsonify({'error': 'clerkUserId is required'}), 400

        user_profile = user_profiles_collection.find_one({'clerkUserId': clerk_user_id})
        
        if not user_profile:
            return jsonify({'goals': []}), 200
        
        goals = user_profile.get('goals', [])
        return jsonify({'goals': goals}), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/user-profile/goals', methods=['POST'])
def add_goal():
    """Add a new goal"""
    try:
        data = request.json
        clerk_user_id = data.get('clerkUserId')
        
        if not clerk_user_id:
            return jsonify({'error': 'clerkUserId is required'}), 400

        # Extract goal data
        goal_data = {
            'id': data.get('id'),
            'name': data.get('name'),
            'icon': data.get('icon'),
            'target': data.get('target'),
            'current': data.get('current')
        }

        # Update user profile - add goal to array
        result = user_profiles_collection.update_one(
            {'clerkUserId': clerk_user_id},
            {
                '$push': {'goals': goal_data},
                '$set': {'updatedAt': datetime.utcnow()}
            },
            upsert=True
        )

        return jsonify({
            'message': 'Goal added successfully',
            'goal': goal_data
        }), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/user-profile/goals/<goal_id>', methods=['PUT'])
def update_goal(goal_id):
    """Update an existing goal"""
    try:
        data = request.json
        clerk_user_id = data.get('clerkUserId')
        
        if not clerk_user_id:
            return jsonify({'error': 'clerkUserId is required'}), 400

        # Update the specific goal in the array
        result = user_profiles_collection.update_one(
            {
                'clerkUserId': clerk_user_id,
                'goals.id': goal_id
            },
            {
                '$set': {
                    'goals.$.name': data.get('name'),
                    'goals.$.icon': data.get('icon'),
                    'goals.$.target': data.get('target'),
                    'goals.$.current': data.get('current'),
                    'updatedAt': datetime.utcnow()
                }
            }
        )

        if result.modified_count == 0:
            return jsonify({'error': 'Goal not found'}), 404

        return jsonify({'message': 'Goal updated successfully'}), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500


@app.route('/api/user-profile/goals/<goal_id>', methods=['DELETE'])
def delete_goal(goal_id):
    """Delete a goal"""
    try:
        clerk_user_id = request.args.get('clerkUserId')
        
        if not clerk_user_id:
            return jsonify({'error': 'clerkUserId is required'}), 400

        # Remove the goal from the array
        result = user_profiles_collection.update_one(
            {'clerkUserId': clerk_user_id},
            {
                '$pull': {'goals': {'id': goal_id}},
                '$set': {'updatedAt': datetime.utcnow()}
            }
        )

        if result.modified_count == 0:
            return jsonify({'error': 'Goal not found'}), 404

        return jsonify({'message': 'Goal deleted successfully'}), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500



# ==================== END OF NEW ENDPOINTS ====================

# if __name__ == '__main__':
#     # Initialize database before running
#     init_app()
#     app.run(debug=True, host='0.0.0.0', port=5000)
if __name__ == '__main__':
    init_app()
    # UPDATED - Set debug=False for cleaner logs (True for development debugging)
    app.run(debug=True, host='0.0.0.0', port=5000, use_reloader=False)
    # use_reloader=False prevents the double-load issue



















































# --- Flask/FastAPI Integration Example ---
# Uncomment and modify based on your framework

# from flask import Flask, request, jsonify
# from flask_cors import CORS
# 
# app = Flask(__name__)
# CORS(app)
# 
# @app.route('/ai-financial-path', methods=['POST'])
# def ai_financial_path():
#     try:
#         user_input = request.form.get('input', '')
#         risk = request.form.get('risk', 'conservative')
#         
#         # üîπ AUTOMATIC USER DATA FETCHING - START
#         # Fetch user data from your database/session
#         # Example:
#         # user_id = request.headers.get('User-ID') or session.get('user_id')
#         # user_data = fetch_user_data_from_db(user_id)
#         # 
#         # user_data could be:
#         # {
#         #     'income': '‚Çπ12,00,000 per annum',
#         #     'existingInvestments': 'PPF: ‚Çπ2L, EPF: ‚Çπ5L',
#         #     'liabilities': 'Home Loan EMI: ‚Çπ25,000/month',
#         #     'dependents': 2,
#         #     'age': 32,
#         #     'employmentStatus': 'Employed',
#         #     'emergencyFund': '‚Çπ3,00,000',
#         #     'insuranceCoverage': 'Life: ‚Çπ50L, Health: ‚Çπ10L'
#         # }
#         
#         user_data_json = request.form.get('userData', '{}')
#         user_data = json.loads(user_data_json) if user_data_json else {}
#         # üîπ AUTOMATIC USER DATA FETCHING - END
#         
#         response = get_gemini_response(user_input, risk, user_data)
#         response_json = json.loads(response)
#         
#         return jsonify(response_json)
#     
#     except Exception as e:
#         return jsonify({"error": str(e)}), 500
# 
# if __name__ == '__main__':
#     app.run(debug=True, port=5000)

# --- Run from terminal (for testing) ---











































































































































# import os
# import google.generativeai as genai
# from dotenv import load_dotenv

# # Load API key
# load_dotenv()
# genai.configure(api_key=os.environ["GEMINI_API_KEY"])

# # --- Simple Config ---
# generation_config = {
#     "temperature": 0.6,
#     "top_p": 0.95,
#     "max_output_tokens": 8192,
#     "response_mime_type": "application/json"  # ‚úÖ plain text output
# }

# # --- Simple System Instruction ---
# # SYSTEM_INSTRUCTION = # In your Python backend file (e.g., app.py or a utils file)

# SYSTEM_INSTRUCTION = """
# You are an expert Indian financial advisor.
# Given a user's investment query and risk profile, generate a personalized investment pathway.
# Return the response as a single, minified JSON object with two keys: "nodes" and "edges".

# - The "nodes" array should contain objects for each step in the investment plan (e.g., "Initial Investment", "Asset Allocation", "Specific Instruments"). Each node object must have:
#   - "id": A unique string identifier.
#   - "position": An object with "x" and "y" coordinates.
#   - "data": An object with a "label" key containing the node's text.
#   - "style": An object with "background", "border" keys for styling.

# - The "edges" array should contain objects representing the connections between nodes. Each edge object must have:
#   - "id": A unique string identifier (e.g., "e1-2").
#   - "source": The "id" of the starting node.
#   - "target": The "id" of the ending node.
#   - "label": (Optional) Text to display on the connection.
#   - "style": An object with a "stroke" key for styling.

# Do NOT return any text outside of this JSON object.
# """
# # SYSTEM_INSTRUCTION = """
# # You are an expert Indian financial advisor.
# # Given a user's investment query and risk profile, generate a personalized investment pathway.
# # Return a single, minified JSON object with two top-level keys: "explanation" and "flowchart".

# # 1.  The "explanation" key must contain a human-readable paragraph (2-4 sentences) summarizing the investment strategy, its reasoning, and expected outcomes. Use Indian currency (‚Çπ) and financial terms.
# # 2.  The "flowchart" key must contain an object with two keys: "nodes" and "edges", formatted for a flowchart library.
# #     - "nodes" should be an array of objects, each with an "id", "position", "data" (with a "label"), and "style".
# #     - "edges" should be an array of objects connecting the nodes.

# # IMPORTANT: Keep the node labels concise. The detailed summary goes in the "explanation" field.
# # Do NOT return any text outside of this single JSON object.
# # """

# model = genai.GenerativeModel(
#     model_name="gemini-2.5-pro",
#     generation_config=generation_config,
#     system_instruction=SYSTEM_INSTRUCTION
# )

# def get_gemini_response(user_input: str, risk: str) -> str:
#     try:
#         prompt = f"User Query: '{user_input}'\nRisk Profile: '{risk}'"
#         response = model.generate_content(prompt)
#         return response.text.strip()
#     except Exception as e:
#         return f"‚ö†Ô∏è Error: {e}"

# # --- Run from terminal ---
# if __name__ == "__main__":
#     test_query = "I have ‚Çπ1 lakh to invest for 3-5 years. Safety is my primary concern."
#     test_risk = "Conservative"

#     print(f"Test Query: {test_query}")
#     print(f"Risk Profile: {test_risk}\n")
#     print("--- Gemini Response ---")
#     print(get_gemini_response(test_query, test_risk))































































































































































# #=========================================================================================================================
# # Upgraded to Gemini 2.5 Pro from Gemini 1.5 Flash for better performance and reliability.
# # Improved system instructions to ensure structured JSON output for investment pathways.
# #=========================================================================================================================
# import os
# import google.generativeai as genai
# import json
# from dotenv import load_dotenv

# # Load environment variables from .env file
# load_dotenv()

# # --- Configuration ---
# try:
#     genai.configure(api_key=os.environ["GEMINI_API_KEY"])
# except KeyError:
#     print("ERROR: GEMINI_API_KEY not found in environment variables.")
#     exit()

# # --- Model Setup ---
# # Upgraded to Gemini 1.5 Pro and configured to enforce JSON output
# generation_config = {
#     "temperature": 0.5, # Reduced for more factual, less "creative" financial advice
#     "top_p": 0.95,
#     "top_k": 40,
#     "max_output_tokens": 8192,
#     # "response_mime_type": "application/json", # Enforce JSON output
#     "response_mime_type": "text/plain", # Using text/plain to handle parsing manually
# }

# # System instruction to guide the model for better, structured responses
# SYSTEM_INSTRUCTION = """
# You are an expert financial advisor for the Indian market.

# Respond in valid JSON with exactly two keys: "summary" and "flowData".

# 1. "summary": A short paragraph (2‚Äì3 sentences) explaining the investment plan.
# 2. "flowData": Contains two arrays ‚Äî "nodes" and "edges" ‚Äî representing how funds are allocated.

# Rules:
# - Always include a node with id "start" for the total investment.
# - Other nodes represent asset classes (FDs, Mutual Funds, Gold, etc.).
# - Edges connect "start" to each node with labels like "30% ‚Çπ30,000".
# - Conservative = safer investments, Aggressive = more equity exposure.
# - Use only valid JSON, no extra text.
# """

# # SYSTEM_INSTRUCTION = """
# # You are an expert financial advisor for the Indian market. Your goal is to provide a clear, actionable, and human-readable investment recommendation based on a user's query and their selected risk profile.

# # You must provide your response as a well-written text explanation (in English), not in JSON, code blocks, or any structured format.

# # Your response should be detailed, formatted in complete sentences, and should read naturally ‚Äî as if you are speaking to a client. Do not use headings, markdown syntax, or lists unless absolutely necessary. Keep your writing formal but friendly, concise, and practical.

# # The response should follow this structure:

# # 1. **Opening Summary (2‚Äì3 sentences)**  
# #    Start with a short overview that restates the user‚Äôs goal and summarizes the investment direction you recommend (e.g., balanced, growth-oriented, safety-first, etc.).

# # 2. **Detailed Breakdown (2‚Äì3 paragraphs)**  
# #    Explain *why* this approach suits their risk profile and time horizon.  
# #    Mention approximate allocations in percentage terms (e.g., 40% Fixed Deposits, 35% Debt Mutual Funds, 25% Equity Funds), but do not use JSON or tables.  
# #    Give reasoning ‚Äî for example:  
# #    - Conservative investors ‚Üí prefer stable, low-risk instruments like FDs, Debt Funds, and Government Schemes.  
# #    - Moderate investors ‚Üí should mix equities and debt for steady growth.  
# #    - Aggressive investors ‚Üí can take higher risk with more exposure to equity and small/mid-cap funds.

# # 3. **Closing Advice (1‚Äì2 sentences)**  
# #    End with an encouraging recommendation or cautionary note, reminding the user about diversification, review frequency, or consulting a financial planner if needed.

# # ---

# # **Tone & Style Guidelines:**
# # - Write naturally ‚Äî like a human advisor, not a bot.  
# # - Avoid lists or bullet points unless they aid clarity.  
# # - Mention Indian-specific instruments (FDs, Mutual Funds, NPS, PPF, Gold ETFs, etc.).  
# # - Use the ‚Çπ symbol for currency and Indian numbering format (‚Çπ1,00,000 not ‚Çπ100,000).  
# # - Do not include any JSON, code snippets, or structural formatting in the output.  

# # **Example Expected Output:**

# # > Based on your conservative risk profile and a 3‚Äì5 year investment horizon, your focus should be on capital safety with limited market exposure. A suitable plan would allocate around 50% of your ‚Çπ1,00,000 investment to Fixed Deposits, 30% to high-quality Debt Mutual Funds, and the remaining 20% to Large-Cap Equity Funds for moderate growth potential.  
# # >  
# # > This mix ensures stability while allowing a small equity component to outpace inflation. Regularly reviewing your portfolio every 12‚Äì18 months can help maintain balance as market conditions change.

# # ---

# # **In summary:**  
# # You must output a *plain text explanation* that feels like an authentic, professional financial recommendation tailored to the user‚Äôs situation.
# # """

# model = genai.GenerativeModel(
#     model_name="gemini-2.5-pro", # Using the more powerful Pro model
#     generation_config=generation_config,
#     system_instruction=SYSTEM_INSTRUCTION,
# )

# def get_gemini_response(user_input: str, risk: str) -> dict:
#     """
#     Generates a personalized investment pathway using the Gemini Pro model.

#     Args:
#         user_input: The user's query about their investment goals.
#         risk: The user's selected risk profile ('Conservative', 'Moderate', 'Aggressive').

#     Returns:
#         A dictionary containing the investment plan or an error message.
#     """
#     try:
#         # Create a more detailed prompt for the model
#         prompt = f"User Query: '{user_input}', Risk Profile: '{risk}'"

#         response = model.generate_content(prompt)
        
#         # The API response is already a parsed JSON object due to response_mime_type
#         return json.loads(response.text)

#     except Exception as e:
#         print(f"An error occurred: {e}")
#         # Return a structured error message for the frontend to handle
#         return {
#             "error": "Failed to generate investment path. The model may be unavailable or the request could not be processed. Please try again later."
#         }

# # --- Main execution block for testing ---
# if __name__ == "__main__":
#     # Sample test query matching the UI
#     test_query = "I have ‚Çπ1 lakh to invest for 3-5 years. Safety is my primary concern."
#     test_risk = "Conservative"
    
#     print(f"Test Query: {test_query}")
#     print(f"Risk Profile: {test_risk}")
    
#     response_data = get_gemini_response(test_query, test_risk)
    
#     # Pretty-print the JSON response for readability
#     print("\n--- Gemini Response ---")
#     print(json.dumps(response_data, indent=2))




















































































































































































#======================================================================================================================================
# # Previous version of the code before the upgrade to Gemini 2.5 Pro
# # Retained for reference; not used in current implementation
# =====================================================================================================================================


# import os
# import google.generativeai as genai
# import re
# import json
# from dotenv import load_dotenv

# load_dotenv()

# genai.configure(api_key=os.environ["GEMINI_API_KEY"])

# # Create the model
# generation_config = {
#   "temperature": 1,
#   "top_p": 0.95,
#   "top_k": 40,
#   "max_output_tokens": 8192,
#   "response_mime_type": "text/plain",
# }

# model = genai.GenerativeModel(
#   model_name="gemini-1.5-flash",
#   generation_config=generation_config,
#   system_instruction="You are a personal financial advisor dedicated to helping in  financial journey. Focus on providing guidance on budgeting, investing, retirement planning, debt management, and wealth building strategies. Be precise and practical in your advice while considering individual circumstances.\\n\\nKey areas of expertise:\\n- Budgeting and expense tracking\\n- Investment strategies and portfolio management\\n- Retirement planning\\n- Debt management and elimination\\n- Tax planning considerations\\n- Emergency fund planning\\n- Risk management and insurance\\n\\nProvide balanced, ethical financial advice and acknowledge when certain situations may require consultation with other financial professionals.\n\nYou can increase the number of nodes and edges in the response if needed.\n\nFor the given user query you have to response a proper output by giving proper response in the following format\nStrictly follow the given format only\n\n\n\n{\n  \"nodes\": [\n    {\n      \"id\": \"start\",\n      \"position\": { \"x\": 250, \"y\": 50 },\n      \"data\": { \"label\": \"Investment\\n‚Çπ1,00,000\" },\n      \"style\": {\n        \"background\": \"bg-blue-100\",\n        \"border\": \"border-blue-500\"\n      }\n    },\n    {\n      \"id\": \"index\",\n      \"position\": { \"x\": 50, \"y\": 200 },\n      \"data\": { \"label\": \"Index Funds\\n‚Çπ40,000\" },\n      \"style\": {\n        \"background\": \"bg-indigo-100\",\n        \"border\": \"border-indigo-500\"\n      }\n    },\n    {\n      \"id\": \"midcap\",\n      \"position\": { \"x\": 250, \"y\": 200 },\n      \"data\": { \"label\": \"Mid-Cap Stocks\\n‚Çπ35,000\" },\n      \"style\": {\n        \"background\": \"bg-orange-100\",\n        \"border\": \"border-orange-500\"\n      }\n    },\n    {\n      \"id\": \"gold\",\n      \"position\": { \"x\": 450, \"y\": 200 },\n      \"data\": { \"label\": \"Gold Investment\\n‚Çπ25,000\" },\n      \"style\": {\n        \"background\": \"bg-yellow-100\",\n        \"border\": \"border-yellow-500\"\n      }\n    }\n  ],\n  \"edges\": [\n    {\n      \"id\": \"e-index\",\n      \"source\": \"start\",\n      \"target\": \"index\",\n      \"label\": \"40%\",\n      \"style\": { \"stroke\": \"stroke-indigo-500\" }\n    },\n    {\n      \"id\": \"e-midcap\",\n      \"source\": \"start\",\n      \"target\": \"midcap\",\n      \"label\": \"35%\",\n      \"style\": { \"stroke\": \"stroke-orange-500\" }\n    },\n    {\n      \"id\": \"e-gold\",\n      \"source\": \"start\",\n      \"target\": \"gold\",\n      \"label\": \"25%\",\n      \"style\": { \"stroke\": \"stroke-yellow-500\" }\n    }\n  ]\n}",
# )

# chat_session = model.start_chat(
#   history=[
#   ]
# )

# def get_gemini_response(user_input: str, risk:str) -> str:
#     response = chat_session.send_message(f'{user_input} \nMy risk profile is:{risk}')
#     markdown_text = response.text
#     # Extract content between ```json and ``` blocks
#     json_match = re.search(r'```json\s*(.*?)\s*```', markdown_text, re.DOTALL)
#     print(json_match.group(1))
#     if json_match:
#         resp = json.loads(json_match.group(1))
#     else:
#         # Fallback to try parsing the entire response as JSON
#         resp = json.loads(markdown_text)

#     return resp

# if __name__ == "__main__":
#     # Sample test query
#     test_query = "I have around ten lakh rupees where should I invest them"
#     print("Test Query:", test_query)
#     response = get_gemini_response(test_query)
#     print("Response:", response)






















































































//==========================================================================================================================================
// SLIGHTLY UPGRADED VERSION BUT STILL IGNORE THIS TOO
//==========================================================================================================================================

// import { useCallback, useState, useRef, useEffect } from 'react';
// import axios from 'axios';
// import {
//   ReactFlow,
//   Controls,
//   Background,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   Connection,
//   Edge,
//   Node
// } from '@xyflow/react';
// import '@xyflow/react/dist/style.css';
// import { Mic, MicOff, Send } from 'lucide-react';
// import { useTheme } from '../context/ThemeContext';
// import { SERVER_URL } from '../utils';

// // Define custom types for Speech Recognition
// declare global {
//   interface Window {
//     SpeechRecognition: any;
//     webkitSpeechRecognition: any;
//   }
// }

// interface SpeechRecognitionResult {
//   transcript: string;
//   isFinal: boolean;
// }

// interface SpeechRecognitionResultList {
//   length: number;
//   [index: number]: {
//     [index: number]: SpeechRecognitionResult;
//   };
// }

// interface CustomSpeechRecognitionEvent {
//   resultIndex: number;
//   results: SpeechRecognitionResultList;
// }

// interface CustomSpeechRecognitionErrorEvent {
//   error: string;
// }

// interface StrategyStyle {
//   background: string;
//   border: string;
//   stroke?: string;
// }

// // Extend the Node type from ReactFlow
// interface FlowNode extends Node {
//   style: StrategyStyle;
// }

// // Extend the Edge type from ReactFlow
// interface FlowEdge extends Edge {
//   style: StrategyStyle;
// }

// interface LegendItem {
//   color: string;
//   label: string;
// }

// interface Strategy {
//   name: string;
//   color: string;
//   description: string;
//   expectedReturns: string;
//   initialInvestment: number;
//   nodes: FlowNode[];
//   edges: FlowEdge[];
//   legend: LegendItem[];
// }

// interface Recommendation {
//   selectedStrategy: string;
//   riskLevel: string;
//   expectedReturns: string;
//   explanation: string;
// }

// interface ServerResponse {
//   nodes: FlowNode[];
//   edges: FlowEdge[];
// }

// interface SampleInput {
//   title: string;
//   text: string;
// }

// const sampleInputs: SampleInput[] = [
//   {
//     title: "Conservative Investor",
//     text: ""
//   },
//   {
//     title: "Balanced Growth",
//     text: "i want to invest 10 lakhs based on the risk give me differrent assets classes"
//   },
//   {
//     title: "Aggressive Growth",
//     text: "I'm seeking high returns and can take high risks. I want to invest ‚Çπ1 lakh for 7-10 years in growth-oriented instruments. Market volatility doesn't worry me."
//   }
// ];

// const FinancialPathFlow = () => {
//   const { theme } = useTheme();
//   const [activeTab, setActiveTab] = useState('conservative');
//   const [userInput, setUserInput] = useState('');
//   const [isListening, setIsListening] = useState(false);
//   const [isGenerating, setIsGenerating] = useState(false);
//   const [showFlowchart, setShowFlowchart] = useState(false);
//   const textareaRef = useRef<HTMLTextAreaElement>(null);
//   const [serverData, setServerData] = useState<ServerResponse | null>(null);
//   const flowchartRef = useRef<HTMLDivElement>(null);

//   // Cast the entire hook call to any to bypass type checking
//   const [nodes, setNodes, onNodesChange] = useNodesState([]) as any;
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]) as any;

//   const onConnect = useCallback(
//     (params: Connection | Edge) => setEdges((eds: any) => addEdge(params, eds)),
//     [setEdges]
//   );

//   const handleSpeechToText = () => {
//     if (!isListening) {
//       const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
//       if (SpeechRecognition) {
//         const recognition = new SpeechRecognition();
//         recognition.continuous = true;
//         recognition.interimResults = true;
//         recognition.lang = 'en-IN';

//         recognition.onstart = () => {
//           setIsListening(true);
//         };

//         recognition.onresult = (event: CustomSpeechRecognitionEvent) => {
//           let transcript = '';
//           for (let i = event.resultIndex; i < event.results.length; i++) {
//             transcript += event.results[i][0].transcript;
//           }
//           setUserInput(transcript);
//           if (textareaRef.current) {
//             textareaRef.current.value = transcript;
//           }
//         };

//         recognition.onerror = (event: CustomSpeechRecognitionErrorEvent) => {
//           console.error('Speech recognition error:', event.error);
//           setIsListening(false);
//         };

//         recognition.onend = () => {
//           setIsListening(false);
//         };

//         recognition.start();
//       } else {
//         alert('Speech recognition is not supported in your browser.');
//       }
//     } else {
//       setIsListening(false);
//       window.speechSynthesis.cancel();
//     }
//   };

//   const handleStrategySelect = (strategy: string) => {
//     setActiveTab(strategy);
//   };

//   const handleGenerate = async () => {
//     if (!activeTab) return;
    
//     setIsGenerating(true);
//     setShowFlowchart(false);
    
//     try {
//       const formData = new FormData();
//       formData.append('input', userInput || 'I\'m looking for a low-risk investment strategy to preserve my capital. I prefer stable returns and want to invest ‚Çπ1 lakh for 3-5 years. Safety is my primary concern.');
//       formData.append('risk', activeTab);

//       const config = {
//         method: 'post',
//         maxBodyLength: Infinity,
//         url: `${SERVER_URL}/ai-financial-path`,
//         data: formData
//       };

//       const response = await axios.request(config);
//       const data: ServerResponse = response.data;
//       setServerData(data);
      
//       // Update nodes and edges with styles
//       setNodes(data.nodes.map(node => ({
//         ...node,
//         className: `${node.style.background} border-2 ${node.style.border} rounded-lg p-4 text-center font-medium`,
//         data: {
//           ...node.data,
//           label: (node.data as { label: string }).label.replace('√¢‚Äö¬π', '‚Çπ')
//         }
//       })));
      
//       setEdges(data.edges.map(edge => ({
//         ...edge,
//         className: edge.style.stroke,
//         source: edge.source,
//         target: edge.target,
//         label: edge.label
//       })));
      
//       setShowFlowchart(true);

//       // Add a small delay to ensure the flowchart is rendered before scrolling
//       setTimeout(() => {
//         flowchartRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
//       }, 100);
      
//     } catch (error) {
//       console.error('Error generating pathway:', error);
//     } finally {
//       setIsGenerating(false);
//     }
//   };

//   const handleTextareaInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
//     setUserInput(e.target.value);
//     // Automatically adjust height
//     if (textareaRef.current) {
//       textareaRef.current.style.height = 'auto';
//       textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
//     }
//   };

//   const handleSampleInput = (text: string) => {
//     setUserInput(text);
//     if (textareaRef.current) {
//       textareaRef.current.style.height = 'auto';
//       textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
//     }
//   };

//   const tabs = [
//     {
//       id: 'conservative',
//       label: 'Conservative',
//       color: 'indigo',
//       description: 'Low-risk approach focusing on capital preservation with stable returns',
//       returns: '7-9% p.a.'
//     },
//     {
//       id: 'moderate',
//       label: 'Moderate',
//       color: 'indigo',
//       description: 'Balanced approach with moderate risk and growth potential',
//       returns: '12-15% p.a.'
//     },
//     {
//       id: 'aggressive',
//       label: 'Aggressive',
//       color: 'indigo',
//       description: 'High-risk, high-reward strategy focusing on growth',
//       returns: '15-20% p.a.'
//     }
//   ];

//   return (
//     <div className="max-w-7xl mx-auto px-4 py-8 space-y-8">
//       {/* Header Section */}
//       <div className="text-center mb-8">
//         <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">Investment Pathway Generator</h1>
//         <p className="text-gray-600 dark:text-gray-300">Create your personalized investment strategy based on your goals and risk tolerance</p>
//       </div>

//       {/* Input Card */}
//       <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:shadow-2xl">
//         {/* Sample Inputs */}
//         <div className="p-4 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 border-b border-gray-200 dark:border-gray-700">
//           <div className="flex items-center mb-2">
//             <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Sample Inputs:</span>
//             <span className="ml-2 text-xs text-gray-500 dark:text-gray-400">(Click to populate)</span>
//           </div>
//           <div className="flex flex-wrap gap-2">
//             {sampleInputs.map((sample, index) => (
//               <button
//                 key={index}
//                 onClick={() => handleSampleInput(sample.text)}
//                 className="px-3 py-1.5 text-sm bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-indigo-400 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all duration-200 flex items-center group"
//               >
//                 <span className="text-gray-600 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-300">{sample.title}</span>
//               </button>
//             ))}
//           </div>
//         </div>

//         {/* Textarea and Strategy Selection */}
//         <div className="p-6 space-y-6">
//           <div className="relative">
//             <textarea
//               ref={textareaRef}
//               value={userInput}
//               onChange={handleTextareaInput}
//               placeholder="Describe your investment goals, risk tolerance, and preferences..."
//               className="w-full min-h-[120px] p-5 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl resize-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-300"
//               style={{ height: 'auto' }}
//             />
//             <button
//               onClick={handleSpeechToText}
//               className={`absolute top-5 right-5 p-2.5 rounded-full transition-all duration-300 transform hover:scale-105 ${
//                 isListening 
//                   ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50' 
//                   : 'bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500'
//               }`}
//             >
//               {isListening ? <MicOff className="h-5 w-5" /> : <Mic className="h-5 w-5" />}
//             </button>
//           </div>

//           {/* Strategy Selection */}
//           <div className="grid grid-cols-3 gap-4">
//             {tabs.map((tab) => (
//               <button
//                 key={tab.id}
//                 onClick={() => handleStrategySelect(tab.id)}
//                 className={`p-4 rounded-xl border-2 transition-all duration-300 transform hover:scale-102 ${
//                   activeTab === tab.id
//                     ? `border-indigo-500 dark:border-indigo-400 bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/30 dark:to-indigo-800/30 text-indigo-700 dark:text-indigo-300 shadow-md`
//                     : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
//                 }`}
//               >
//                 <div className="font-semibold">{tab.label}</div>
//                 <div className="text-sm mt-1 opacity-75">Returns: {tab.returns}</div>
//               </button>
//             ))}
//           </div>
//         </div>

//         {/* Generate Button */}
//         <div className="p-6 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 border-t border-gray-200 dark:border-gray-700">
//           <button
//             onClick={handleGenerate}
//             disabled={!activeTab || isGenerating}
//             className={`w-full flex items-center justify-center space-x-3 px-8 py-4 rounded-xl text-lg font-medium transition-all duration-300 transform hover:scale-102 ${
//               activeTab && !isGenerating
//                 ? 'bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white shadow-lg hover:shadow-xl'
//                 : 'bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-not-allowed'
//             }`}
//           >
//             <Send className="h-6 w-6" />
//             <span>{isGenerating ? 'Analyzing Your Preferences...' : 'Generate Investment Pathway'}</span>
//           </button>
//         </div>
//       </div>

//       {/* Loading State */}
//       {isGenerating && (
//         <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-10 text-center max-w-2xl mx-auto">
//           <div className="animate-spin rounded-full h-16 w-16 border-4 border-indigo-600 dark:border-indigo-400 border-t-transparent mx-auto"></div>
//           <h3 className="mt-6 text-xl font-semibold text-gray-900 dark:text-white">Creating Your Personalized Investment Pathway</h3>
//           <p className="mt-3 text-gray-600 dark:text-gray-300">
//             Analyzing your preferences and generating the optimal investment strategy...
//           </p>
//         </div>
//       )}

//       {/* Flowchart Display */}
//       {showFlowchart && serverData && (
//         <div ref={flowchartRef} className="space-y-6 animate-fade-in scroll-mt-8">
//           {/* Flowchart */}
//           <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
//             <div className="h-[700px] w-full bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700">
//               <ReactFlow
//                 nodes={nodes}
//                 edges={edges}
//                 onNodesChange={onNodesChange}
//                 onEdgesChange={onEdgesChange}
//                 onConnect={onConnect}
//                 fitView
//                 className="bg-gray-50 dark:bg-gray-800"
//                 defaultEdgeOptions={{
//                   type: 'smoothstep',
//                   animated: true,
//                   style: { strokeWidth: 2 }
//                 }}
//               >
//                 <Background color={theme === 'dark' ? '#374151' : '#e5e7eb'} />
//                 <Controls />
//               </ReactFlow>
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// };

// export default FinancialPathFlow; 

































































// =========================================================================================================================================
// =========================================================================================================================================
// --- IGNORE ---
// Previous version of the code before the upgrade to Gemini 2.5 Pro
// Retained for reference; not used in current implementation
// =====================================================================================================================================
// =====================================================================================================================================


// import { useCallback, useState, useRef } from 'react';
// import axios from 'axios';
// import {
//   ReactFlow,
//   Controls,
//   Background,
//   useNodesState,
//   useEdgesState,
//   addEdge,
//   Connection,
//   Edge,
//   Node
// } from '@xyflow/react';
// import '@xyflow/react/dist/style.css';
// import { Mic, MicOff, Send } from 'lucide-react';
// import { useTheme } from '../context/ThemeContext';
// import { SERVER_URL } from '../utils';

// // Define custom types for Speech Recognition
// declare global {
//   interface Window {
//     SpeechRecognition: any;
//     webkitSpeechRecognition: any;
//   }
// }

// interface SpeechRecognitionResult {
//   transcript: string;
//   isFinal: boolean;
// }

// interface SpeechRecognitionResultList {
//   length: number;
//   [index: number]: {
//     [index: number]: SpeechRecognitionResult;
//   };
// }

// interface CustomSpeechRecognitionEvent {
//   resultIndex: number;
//   results: SpeechRecognitionResultList;
// }

// interface CustomSpeechRecognitionErrorEvent {
//   error: string;
// }

// interface StrategyStyle {
//   background: string;
//   border: string;
//   stroke?: string;
// }

// // Extend the Node type from ReactFlow
// interface FlowNode extends Node {
//   style: StrategyStyle;
// }

// // Extend the Edge type from ReactFlow
// interface FlowEdge extends Edge {
//   style: StrategyStyle;
// }

// // MODIFICATION 1: Updated interfaces for the new API response structure
// interface FlowchartData {
//   nodes: FlowNode[];
//   edges: FlowEdge[];
// }

// interface ServerResponse {
//   explanation: string;
//   flowchart: FlowchartData;
// }

// interface SampleInput {
//   title: string;
//   text: string;
// }

// const sampleInputs: SampleInput[] = [
//   {
//     title: "Conservative Investor",
//     text: "I have ‚Çπ1 lakh to invest for 3-5 years. Safety is my primary concern."
//   },
//   {
//     title: "Balanced Growth",
//     text: "I want to invest ‚Çπ10 lakhs based on the risk, give me different asset classes."
//   },
//   {
//     title: "Aggressive Growth",
//     text: "I'm seeking high returns and can take high risks. I want to invest ‚Çπ1 lakh for 7-10 years in growth-oriented instruments. Market volatility doesn't worry me."
//   }
// ];

// const FinancialPathFlow = () => {
//   const { theme } = useTheme();
//   const [activeTab, setActiveTab] = useState('conservative');
//   const [userInput, setUserInput] = useState('');
//   const [isListening, setIsListening] = useState(false);
//   const [isGenerating, setIsGenerating] = useState(false);
//   const [showFlowchart, setShowFlowchart] = useState(false);
//   const textareaRef = useRef<HTMLTextAreaElement>(null);
//   const [serverData, setServerData] = useState<ServerResponse | null>(null);
//   const flowchartRef = useRef<HTMLDivElement>(null);

//   // MODIFICATION 2: Added state to hold the text explanation
//   const [explanation, setExplanation] = useState('');

//   const [nodes, setNodes, onNodesChange] = useNodesState([]) as any;
//   const [edges, setEdges, onEdgesChange] = useEdgesState([]) as any;

//   const onConnect = useCallback(
//     (params: Connection | Edge) => setEdges((eds: any) => addEdge(params, eds)),
//     [setEdges]
//   );

//   const handleSpeechToText = () => {
//     if (!isListening) {
//       const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
//       if (SpeechRecognition) {
//         const recognition = new SpeechRecognition();
//         recognition.continuous = true;
//         recognition.interimResults = true;
//         recognition.lang = 'en-IN';

//         recognition.onstart = () => {
//           setIsListening(true);
//         };

//         recognition.onresult = (event: CustomSpeechRecognitionEvent) => {
//           let transcript = '';
//           for (let i = event.resultIndex; i < event.results.length; i++) {
//             transcript += event.results[i][0].transcript;
//           }
//           setUserInput(transcript);
//           if (textareaRef.current) {
//             textareaRef.current.value = transcript;
//           }
//         };

//         recognition.onerror = (event: CustomSpeechRecognitionErrorEvent) => {
//           console.error('Speech recognition error:', event.error);
//           setIsListening(false);
//         };

//         recognition.onend = () => {
//           setIsListening(false);
//         };

//         recognition.start();
//       } else {
//         alert('Speech recognition is not supported in your browser.');
//       }
//     } else {
//       setIsListening(false);
//       // If there was a recognition object, you'd call recognition.stop() here.
//       // This part of the logic might need refinement depending on the exact speech recognition library usage.
//     }
//   };

//   const handleStrategySelect = (strategy: string) => {
//     setActiveTab(strategy);
//   };

//   // MODIFICATION 3: Updated handleGenerate to process the new data structure
//   const handleGenerate = async () => {
//     if (!activeTab) return;
    
//     setIsGenerating(true);
//     setShowFlowchart(false);
//     setExplanation(''); // Clear previous explanation
    
//     try {
//       const formData = new FormData();
//       formData.append('input', userInput || 'I have ‚Çπ1 lakh to invest for 3-5 years. Safety is my primary concern.');
//       formData.append('risk', activeTab);

//       const config = {
//         method: 'post',
//         maxBodyLength: Infinity,
//         url: `${SERVER_URL}/ai-financial-path`,
//         data: formData
//       };

//       const response = await axios.request(config);
//       const data: ServerResponse = response.data;
      
//       setServerData(data);
//       setExplanation(data.explanation); // Set the text summary
      
//       // Access nodes and edges from the nested 'flowchart' object
//       setNodes(data.flowchart.nodes.map(node => ({
//         ...node,
//         className: `${node.style.background} border-2 ${node.style.border} rounded-lg p-4 text-center font-medium`,
//         data: {
//           ...node.data,
//           label: (node.data as { label: string }).label.replace('√¢‚Äö¬π', '‚Çπ')
//         }
//       })));
      
//       setEdges(data.flowchart.edges.map(edge => ({
//         ...edge,
//         className: edge.style.stroke,
//         source: edge.source,
//         target: edge.target,
//         label: edge.label
//       })));
      
//       setShowFlowchart(true);

//       // Add a small delay to ensure the flowchart is rendered before scrolling
//       setTimeout(() => {
//         flowchartRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
//       }, 100);
      
//     } catch (error) {
//       console.error('Error generating pathway:', error);
//       // You might want to add user-facing error handling here
//     } finally {
//       setIsGenerating(false);
//     }
//   };

//   const handleTextareaInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
//     setUserInput(e.target.value);
//     if (textareaRef.current) {
//       textareaRef.current.style.height = 'auto';
//       textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
//     }
//   };

//   const handleSampleInput = (text: string) => {
//     setUserInput(text);
//     if (textareaRef.current) {
//       // Trigger height adjustment after setting text
//       setTimeout(() => {
//         if (textareaRef.current) {
//             textareaRef.current.style.height = 'auto';
//             textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
//         }
//       }, 0);
//     }
//   };

//   const tabs = [
//     {
//       id: 'conservative',
//       label: 'Conservative',
//       returns: '7-9% p.a.'
//     },
//     {
//       id: 'moderate',
//       label: 'Moderate',
//       returns: '12-15% p.a.'
//     },
//     {
//       id: 'aggressive',
//       label: 'Aggressive',
//       returns: '15-20% p.a.'
//     }
//   ];

//   return (
//     <div className="max-w-7xl mx-auto px-4 py-8 space-y-8">
//       {/* Header Section */}
//       <div className="text-center mb-8">
//         <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">Investment Pathway Generator</h1>
//         <p className="text-gray-600 dark:text-gray-300">Create your personalized investment strategy based on your goals and risk tolerance</p>
//       </div>

//       {/* Input Card */}
//       <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:shadow-2xl">
//         {/* Sample Inputs */}
//         <div className="p-4 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 border-b border-gray-200 dark:border-gray-700">
//           <div className="flex items-center mb-2">
//             <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Sample Inputs:</span>
//             <span className="ml-2 text-xs text-gray-500 dark:text-gray-400">(Click to populate)</span>
//           </div>
//           <div className="flex flex-wrap gap-2">
//             {sampleInputs.map((sample, index) => (
//               <button
//                 key={index}
//                 onClick={() => handleSampleInput(sample.text)}
//                 className="px-3 py-1.5 text-sm bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-indigo-400 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all duration-200 flex items-center group"
//               >
//                 <span className="text-gray-600 dark:text-gray-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-300">{sample.title}</span>
//               </button>
//             ))}
//           </div>
//         </div>

//         {/* Textarea and Strategy Selection */}
//         <div className="p-6 space-y-6">
//           <div className="relative">
//             <textarea
//               ref={textareaRef}
//               value={userInput}
//               onChange={handleTextareaInput}
//               placeholder="Describe your investment goals, risk tolerance, and preferences..."
//               className="w-full min-h-[120px] p-5 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl resize-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all duration-300"
//               style={{ height: 'auto' }}
//             />
//             <button
//               onClick={handleSpeechToText}
//               className={`absolute top-5 right-5 p-2.5 rounded-full transition-all duration-300 transform hover:scale-105 ${
//                 isListening 
//                   ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50' 
//                   : 'bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-500'
//               }`}
//             >
//               {isListening ? <MicOff className="h-5 w-5" /> : <Mic className="h-5 w-5" />}
//             </button>
//           </div>

//           {/* Strategy Selection */}
//           <div className="grid grid-cols-3 gap-4">
//             {tabs.map((tab) => (
//               <button
//                 key={tab.id}
//                 onClick={() => handleStrategySelect(tab.id)}
//                 className={`p-4 rounded-xl border-2 transition-all duration-300 transform hover:scale-102 ${
//                   activeTab === tab.id
//                     ? `border-indigo-500 dark:border-indigo-400 bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/30 dark:to-indigo-800/30 text-indigo-700 dark:text-indigo-300 shadow-md`
//                     : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
//                 }`}
//               >
//                 <div className="font-semibold">{tab.label}</div>
//                 <div className="text-sm mt-1 opacity-75">Returns: {tab.returns}</div>
//               </button>
//             ))}
//           </div>
//         </div>

//         {/* Generate Button */}
//         <div className="p-6 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 border-t border-gray-200 dark:border-gray-700">
//           <button
//             onClick={handleGenerate}
//             disabled={!activeTab || isGenerating}
//             className={`w-full flex items-center justify-center space-x-3 px-8 py-4 rounded-xl text-lg font-medium transition-all duration-300 transform hover:scale-102 ${
//               activeTab && !isGenerating
//                 ? 'bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white shadow-lg hover:shadow-xl'
//                 : 'bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-not-allowed'
//             }`}
//           >
//             <Send className="h-6 w-6" />
//             <span>{isGenerating ? 'Analyzing Your Preferences...' : 'Generate Investment Pathway'}</span>
//           </button>
//         </div>
//       </div>

//       {/* Loading State */}
//       {isGenerating && (
//         <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-10 text-center max-w-2xl mx-auto">
//           <div className="animate-spin rounded-full h-16 w-16 border-4 border-indigo-600 dark:border-indigo-400 border-t-transparent mx-auto"></div>
//           <h3 className="mt-6 text-xl font-semibold text-gray-900 dark:text-white">Creating Your Personalized Investment Pathway</h3>
//           <p className="mt-3 text-gray-600 dark:text-gray-300">
//             Analyzing your preferences and generating the optimal investment strategy...
//           </p>
//         </div>
//       )}

//       {/* Flowchart and Summary Display */}
//       {showFlowchart && serverData && (
//         <div ref={flowchartRef} className="space-y-6 animate-fade-in scroll-mt-8">
          
//           {/* Text Summary Section */}
//           <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-200 dark:border-gray-700">
//             <h2 className="text-xl font-bold text-gray-900 dark:text-white">
//               Investment Strategy Summary
//             </h2>
//             <p className="mt-3 text-gray-600 dark:text-gray-300 leading-relaxed">
//               {explanation}
//             </p>
//           </div>

//           {/* Flowchart */}
//           <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
//             <div className="h-[700px] w-full bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700">
//               <ReactFlow
//                 nodes={nodes}
//                 edges={edges}
//                 onNodesChange={onNodesChange}
//                 onEdgesChange={onEdgesChange}
//                 onConnect={onConnect}
//                 fitView
//                 className="bg-gray-50 dark:bg-gray-800"
//                 defaultEdgeOptions={{
//                   type: 'smoothstep',
//                   animated: true,
//                   style: { strokeWidth: 2 }
//                 }}
//               >
//                 <Background color={theme === 'dark' ? '#374151' : '#e5e7eb'} />
//                 <Controls />
//               </ReactFlow>
//             </div>
//           </div>
//         </div>
//       )}
//     </div>
//   );
// };

// export default FinancialPathFlow;




























































































  const handleGenerate = async () => {
    if (!activeTab) return;
    
    setIsGenerating(true);
    setShowResults(false);
    
    try {
      // üîπ AUTOMATIC USER DATA FETCHING - START
      // TODO: Replace this section with actual user data fetching logic
      // This could fetch from:
      // 1. User profile API endpoint
      // 2. Local storage/session storage
      // 3. Context/Redux store
      // 4. Database query based on authenticated user
      
      const userData = {
        // Example: Fetch from your user management system
        // const userProfile = await axios.get(`${SERVER_URL}/user/profile`);
        // income: userProfile.data.income,
        // existingInvestments: userProfile.data.investments,
        // liabilities: userProfile.data.liabilities,
        // dependents: userProfile.data.dependents,
        // age: userProfile.data.age,
        // employmentStatus: userProfile.data.employmentStatus
      };
      // üîπ AUTOMATIC USER DATA FETCHING - END

      const formData = new FormData();
      formData.append('input', userInput || 'I\'m looking for a low-risk investment strategy to preserve my capital. I prefer stable returns and want to invest ‚Çπ1 lakh for 3-5 years. Safety is my primary concern.');
      formData.append('risk', activeTab);
      
      // üîπ Append automatically fetched user data to the request
      formData.append('userData', JSON.stringify(userData));

      const config = {
        method: 'post',
        maxBodyLength: Infinity,
        url: `${SERVER_URL}/ai-financial-path`,
        data: formData
      };

      const response = await axios.request(config);
      const data: ServerResponse = response.data;
      setServerData(data);
      
      // Update nodes and edges with styles
      setNodes(data.nodes.map(node => ({
        ...node,
        className: `${node.style.background} border-2 ${node.style.border} rounded-lg p-4 text-center font-medium`,
        data: {
          ...node.data,
          label: (node.data as { label: string }).label.replace('‚Çπ', '‚Çπ')
        }
      })));
      
      setEdges(data.edges.map(edge => ({
        ...edge,
        className: edge.style.stroke,
        source: edge.source,
        target: edge.target,
        label: edge.label
      })));
      
      setShowResults(true);

      setTimeout(() => {
        resultsRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      
    } catch (error) {
      console.error('Error generating pathway:', error);
    } finally {
      setIsGenerating(false);
    }
  };